<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="GEXEJrXTMzJpse0YrTLaHZG1JjjzV8wjuvlNDFVK58w"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Soft Disk Lennard-Jones 2D Fluid | Morris Huang</title> <meta name="author" content="Morris Huang"> <meta name="description" content="Numerically simulate 2D Lennard-Jones Fluid using Fortran"> <meta name="keywords" content="Morris-Huang, academic-website, portfolio-website"> <style>.main-container{display:flex;justify-content:space-between;align-items:start;gap:20px}.canvas-container{flex:2;max-width:650px}#myCanvas{width:100%;height:auto}.controls-container{flex:1;display:flex;flex-direction:column;align-items:center;gap:10px}.slider-button-container{display:flex;align-items:center;gap:10px}@media(max-width:600px){.main-container{flex-direction:column;align-items:center}.slider-button-container{flex-direction:row;justify-content:center;align-items:center;gap:10px;width:100%}.canvas-container,.controls-container{flex:none;width:100%}}.slider{-webkit-appearance:none;width:60%;height:15px;background:#d3d3d3;outline:0;opacity:.7;-webkit-transition:.2s;transition:opacity .2s}.slider:hover{opacity:1}.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:25px;height:25px;background:#4caf50;border-radius:50%;cursor:pointer}.slider::-moz-range-thumb{width:25px;height:25px;background:#4caf50;border-radius:50%;cursor:pointer}#bw{display:inline-block;margin-right:10px}.next-element{clear:both}.stylish-button{background-color:#4caf50;color:white;padding:8px 12px;border:0;border-radius:5px;cursor:pointer;font-size:14px;transition:all .3s;box-shadow:0 2px 5px rgba(0,0,0,0.2)}.stylish-button:hover,.stylish-button:focus{background-color:#45a049;box-shadow:0 4px 8px rgba(0,0,0,0.3)}.stylish-button:active{background-color:#3e8e41;box-shadow:0 1px 3px rgba(0,0,0,0.3)}</style> <style>.main-container2{display:flex;justify-content:space-between;align-items:start;gap:20px}.canvas-container2{flex:1;max-width:650px}#myCanvas2{width:100%;height:auto}.controls-container2{flex:2;display:flex;flex-direction:column;align-items:center;gap:10px}.stylish-button2{background-color:#8ea6de;color:white;padding:8px 12px;border:0;border-radius:5px;cursor:pointer;font-size:14px;transition:all .3s;box-shadow:0 2px 5px rgba(0,0,0,0.2)}.stylish-button2:hover,.stylish-button2:focus{background-color:#8ea6de;box-shadow:0 4px 8px rgba(0,0,0,0.3)}.stylish-button2:active{background-color:#8ea6de;box-shadow:0 1px 3px rgba(0,0,0,0.3)}.status2{font-size:16px}@media(max-width:600px){.main-container2{flex-direction:column;align-items:center}.canvas-container2,.controls-container2{flex:none;width:100%}}.combined-container{display:flex;align-items:center;gap:15px}</style> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Shadows+Into+Light&amp;display=swap"> <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&amp;display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&amp;display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&amp;display=swap" rel="stylesheet"> <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet"> <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script> <script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},loader:{load:["[tex]/physics"]}};</script> <script>document.addEventListener("DOMContentLoaded",()=>{MathJax.typesetPromise(["#math-content"])});</script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script src="https://cdn.jsdelivr.net/npm/particles.js"></script> <script src="https://cdn.jsdelivr.net/npm/tsparticles"></script> <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/head_round.png?29a1effb0c495894dc060e6f40dad4ff"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://physics-morris.github.io/projects/lj-fluid/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Soft Disk Lennard-Jones 2D Fluid",
      "description": "Numerically simulate 2D Lennard-Jones Fluid using Fortran",
      "published": "December 21, 2024",
      "authors": [
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="desc" style="font-family: 'Gloria Hallelujah', cursive;">Morris Huang</span></a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">Blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">Teaching</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Misc</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/night-sky/">Night Sky</a> <a class="dropdown-item" href="/gallery/">Gallery</a> <a class="dropdown-item" href="/piano/">Piano</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Soft Disk Lennard-Jones 2D Fluid</h1> <p>Numerically simulate 2D Lennard-Jones Fluid using Fortran</p> </d-title><d-article> <h1 id="soft-disk-lennard-jones-2d-fluid">Soft Disk Lennard-Jones 2D fluid</h1> <p>In this study, our objective is to simulate a soft-disk fluid composed of small particles interacting through the Lennard-Jones potential. This potential exhibits a repulsive behavior at short distances and an attractive behavior at longer distances, as defined by Equation (1): \begin{equation} V\left(r\right)=4\epsilon\left[\left({\dfrac{\sigma}{r}}\right)^{12}-\left({\dfrac{\sigma}{r}}\right)^{6}\right] \tag{1} \end{equation} And the force is the gradient of the potential plus a minus sign \begin{equation} F\left(r\right)= \dfrac{24\epsilon}{r}\dfrac{\sigma}{r}^{6}[2\left({\dfrac{\sigma}{r}}\right)^{6}-1] \tag{2} \end{equation}</p> <h2 id="verlet-and-predictor-corrector-method">Verlet and Predictor-Corrector method</h2> <p>In our pursuit of solving the equations of motion for this complex system, we explore two efficient and accurate methods: the Velocity Verlet method and the Predictor-Corrector method. Due to the relatively large number of particles in this system, our chosen method must strike a balance between computational efficiency and precision. Both the Verlet and Predictor-Corrector methods are widely recognized and employed for such simulations.</p> <h3 id="verlet-method">Verlet Method</h3> <p>We begin by implementing the Velocity Verlet method and conduct convergence tests on both energy and momentum. The results are promising, especially as we decrease the time step (\(dt\)) to values as small as \(dt=10^{-4}\). The reduction in error and convergence of both energy and momentum demonstrate the effectiveness of this method.</p> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/0.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <h3 id="predictor-corrector-method">Predictor-Corrector Method</h3> <p>Taking our simulation a step further, we introduce the Predictor-Corrector method. This method’s core principle revolves around iteratively reducing the difference between predictor and corrector values until a desired tolerance is reached. The graph below illustrates the diminishing difference between predictor and corrector values after each correction step. This difference eventually reaches machine accuracy after approximately 8 iterations. In our program, we employ two criteria to evaluate the adequacy of the corrector: first, it must iterate at least 4 times, and second, the difference must fall below a defined tolerance. If the value fails to converge after 8 iterations, we halt the iteration process.</p> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/1.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <p>Furthermore, we conduct convergence tests using the Predictor-Corrector method with difference tolerance. The results indicate superior accuracy compared to the Verlet method, as depicted in the table summarizing the advantages and disadvantages of both methods.</p> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/3.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/4.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <p>As evident from the convergence figures above, we also monitor the system’s temperature, which gradually approaches equilibrium. Additionally, we analyze the probability distributions of speed, denoted as $P(v_x)$, $P(v_y)$, and $P(v)$, at various temperatures. The three columns represent different initial velocities, resulting in varying equilibrium temperatures.</p> <h2 id="periodic-boundary-condition">Periodic Boundary Condition</h2> <p>To accurately model our infinite 2D system, we implement periodic boundary conditions. This approach ensures that when a particle reaches one side of the simulated space, it seamlessly reappears on the opposite side. Consequently, we calculate the forces acting on each particle while taking into account the periodic images created by the boundary conditions. This technique allows us to simulate an effectively boundless system while preserving the physics of particle interactions.</p> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/5.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <h2 id="maxwell-boltzmann-distribution">Maxwell-Boltzmann distribution</h2> <p>As you can see, according to Maxwell-Boltzmann distribution when the temperature are lower the distribution are more center at low speed with a higher peak, but if the temperature increase the distribution spreads out and the height also decrease. Since our system are smaller (only 49 particles), the distribution looks very discrete. If we increase the number of particles, the equilibrium temperature increase and the graph become smoother. Since the temperature also higher the distribution didn’t seem much difference, but we can still see that the peak of each distribution shift to higher velocity.</p> \[NP = 49\] <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/6.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> \[NP = 100\] <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/7.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <h2 id="temperature-and-pressure">Temperature and Pressure</h2> <p>The formula for measuring temperature and pressure are given below. \begin{equation} k_BT = \dfrac{m}{d} \langle v^2 \rangle \tag{3} \end{equation} and \begin{equation} P = \dfrac{1}{A} \left[ Nk_BT - \dfrac{1}{2} \sum_{k=1}^{N} \sum_{j&lt;k} \dfrac{dV(r)}{dr}r_{jk} \right] \tag{4} \end{equation} Using above two equation we can monitor system temperature and pressure at all time. Below show that after some time both temperature and pressure goes to equilibrium.</p> \[NP = 49\] <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/8.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> \[NP = 100\] <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/9.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <h2 id="heat-capacity">Heat Capacity</h2> <p>If we then measure the energy after equilibrium and then by varying the initial velocity using following formula we can get roughly the desire equilibrium temperature. \begin{equation} v = v \sqrt{\dfrac{T_{desire}}{T_{old}}} \tag{5} \end{equation} And the heat capacity $c_v$ is given by $\dfrac{dE}{dT}$. Below left figure show the $E(t)$ relation. The energy is negative is because it is govern by potential energy. In the case of $NP=49$ the heat capacity is roughly 58.</p> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/10.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <p>There is an alternatively way of calculating heat capacity which is given by \begin{equation} \langle T^2 \rangle - \langle T \rangle^2 = N(k_B \langle T \rangle)^2 [1-\dfrac{Nk_B}{c_v}]. \tag{6} \end{equation} Using this formula we then measure the same system for heat capacity, the heat capacity are different by some degree when $NP=100$ . But if we look at same method for two different number of particles, you can see that $c_v$ roughly double as the particle number double which is what we expected.</p> \[NP = 49\] <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/11.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> \[NP = 100\] <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/12.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <h2 id="pair-correlation-of-lj-fluid">Pair correlation of LJ fluid</h2> <div class="row"> <center> <div class="col-sm-12"> <figure> <picture> <img src="/assets/img/lj_fluid/13.jpg" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </center> </div> <h2 id="code">Code</h2> <pre><code class="language-fortran=">!========================================================
!   purpose: MD simulation
!
!   methods: velocity verlet + predictor-corrector
!
!   input: NP, L, maxt, vmax, h
!
!   output: position, velocity, T, K, U, P, Cv
!
!       date        programer       description of change
!       ====        =========       =====================
!     11/19/20       morrisH        original code
!========================================================
program MD
    implicit none
    integer :: NP, i, n, j
    double precision :: L, maxt, h, time, tol
    double precision, dimension(:,:), allocatable :: r, v, rbef
    real :: start, finish
    double precision :: T, vmax, P
    double precision :: TF

    ! parameter
    time = 0.d0
    NP = 100
    L = 8.d0
    maxt = 2.d-1
    h = 1.d-4
    tol = 1.d-17
    vmax = 0.d0
    TF = 1000.d0
    n = nint(maxt / h)

    allocate(r(NP, 2))
    allocate(rbef(NP, 2))
    allocate(v(NP, 2))

    call init(NP, L, r, v, vmax)
    ! call output(NP, L, r, v, time, T, P)

    call cpu_time(start)
    ! move first step
    rbef(i, :) = r(i, :)
    call verlet(NP, L, r, v, h)

    do
        do i = 1, n
            ! call verlet(NP, L, r, v, h)
            call predcorr(NP, L, r, v, h, rbef, tol)
            ! call output(NP, L, r, v, time, T, P)
            call pstatus(n, i, time, T, P)
            time = time + h
        end do

        call output(NP, L, r, v, time, T, P)
        ! rescale velocity
        do j = 1, NP
            v(j, :) = dsqrt((T + 1.d1) / T) * v(j, :)
        end do
        if (T.gt.TF) then; exit; end if
    end do
    call cpu_time(finish)

    write(*, *) 'cost :', finish-start

end program MD

subroutine init(NP, L, r, v, vmax)
    implicit none
    integer :: NP, i, j, num
    double precision :: L, r(NP, 2), v(NP, 2), vmax, dx, dy

    call random_seed()

    num = int(sqrt(dble(NP)))
    dx = L / (dble(num) + 1.d0)
    dy = L / (dble(num) + 1.d0)

    ! random position
    do i = 1, num
        do j = 1, num
            r(num*(i-1)+j, 1) = dble(i) * dx
            r(num*(i-1)+j, 2) = dble(j) * dy
        end do
    end do

    ! random velocity
    call random_number(v)
    v = (v - .5d0) * 2.d0 * vmax
end subroutine init

subroutine output(NP, L, r, v, time, T, P)
    implicit none
    integer :: NP, i, j
    double precision :: r(NP, 2), v(NP, 2), L, K, U, E, Px, Py, T, P, Cv
    double precision :: r1(2), r2(2), d, dx, dy, time
    double precision :: TT

    ! conpute some physical quantity
    K = 0.d0
    U = 0.d0
    Px = 0.d0
    Py = 0.d0
    T = 0.d0
    TT = 0.d0
    P = 0.d0
    do i = 1, NP
        r1 = r(i, :)
        K = K + 0.5d0 * (v(i, 1)**2 + v(i, 2)**2)
        Px = Px + v(i, 1)
        Py = Py + v(i, 2)
        T  = T + (v(i, 1)**2 + v(i, 2)**2)
        TT = TT + (v(i, 1)**2 + v(i, 2)**2)**2
        ! calculate potential energy
        do j = 1, i
            if (i.ne.j) then
                r2 = r(j, :)
                d = dsqrt((r1(1) - r2(1))**2 + (r1(2) - r2(2))**2)
                if (d.gt.(L/2.d0)) then
                    ! find nearest image
                    dx = r2(1) - r1(1)
                    dy = r2(2) - r1(2)
                    if (dx.gt.(L/2.d0))  then; dx = dx - L; end if
                    if (dy.gt.(L/2.d0))  then; dy = dy - L; end if
                    if (dx.lt.(-L/2.d0)) then; dx = dx + L; end if
                    if (dy.lt.(-L/2.d0)) then; dy = dy + L; end if
                    d = dsqrt(dx ** 2 + dy ** 2)
                    U = U + 4.d0 * ( (1.d0 / d)**12 - (1.d0 / d)*6 )
                    P = P + 0.5d0 * (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * d
                else
                    U = U + 4.d0 * ( (1.d0 / d)**12 - (1.d0 / d)*6 )
                    P = P + 0.5d0 * (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * d
                end if
            end if
        end do
    end do
    T = T / NP
    TT = TT / NP
    E = K + U
    P = (P + NP * T) / L**2
    Cv = NP / (1.d0 - (TT - T**2) / (NP * T**2))

    ! open(66, file='data/np49/Cv/r.dat', access='append', status='unknown')
    ! write(66, '(100e40.30)') r(:, 1)
    ! write(66, '(100e40.30)') r(:, 2)
    ! close(66)
    ! open(77, file='data/np49/Cv/v.dat', access='append', status='unknown')
    ! write(77, '(100e40.30)') v(:, 1)
    ! write(77, '(100e40.30)') v(:, 2)
    ! close(77)
    open(66, file='data/np100/Cv/info_alt.dat', access='append', status='unknown')
    write(66, '(9e40.30)') time, K, U, E, Px, Py, T, P, Cv
    close(66)

end subroutine output

subroutine verlet(NP, L, r, v, h)
    implicit none
    integer :: NP, i, j
    double precision :: L, r(NP, 2), v(NP, 2), rnew(NP, 2), vnew(NP, 2)
    double precision :: a1(2), a2(2), d, dx, dy, r1(2), r2(2)
    double precision :: h

    do i = 1, NP
        r1 = r(i, :)
        ! compute a(t)
        a1 = 0.d0
        do j = 1, NP
            if (i.ne.j) then
                r2 = r(j, :)
                d = dsqrt((r1(1) - r2(1))**2 + (r1(2) - r2(2))**2)
                if (d.gt.(L/2.d0)) then
                    ! find nearest image
                    dx = r2(1) - r1(1)
                    dy = r2(2) - r1(2)
                    if (dx.gt.(L/2.d0))  then; dx = dx - L; end if
                    if (dy.gt.(L/2.d0))  then; dy = dy - L; end if
                    if (dx.lt.(-L/2.d0)) then; dx = dx + L; end if
                    if (dy.lt.(-L/2.d0)) then; dy = dy + L; end if
                    d = dsqrt(dx ** 2 + dy ** 2)
                    a1 = a1 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                              (/ -dx, -dy /) / d
                else
                    a1 = a1 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                              (r1 - r2) / d
                end if
            end if
        end do
        rnew(i, :) = r(i, :) + v(i, :) * h + .5d0 * a1 * h ** 2

        ! compute a(t+h)
        a2 = 0.d0
        r1 = rnew(i, :)
        do j = 1, NP
            if (i.ne.j) then
                r2 = r(j, :)
                d = dsqrt((r1(1) - r2(1))**2 + (r1(2) - r2(2))**2)
                if (d.gt.(L/2.d0)) then
                    ! find nearest image
                    dx = r2(1) - r1(1)
                    dy = r2(2) - r1(2)
                    if (dx.gt.(L/2.d0))  then; dx = dx - L; end if
                    if (dy.gt.(L/2.d0))  then; dy = dy - L; end if
                    if (dx.lt.(-L/2.d0)) then; dx = dx + L; end if
                    if (dy.lt.(-L/2.d0)) then; dy = dy + L; end if
                    d = dsqrt(dx ** 2 + dy ** 2)
                    a2 = a2 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                         (/ -dx, -dy /) / d
                else
                    a2 = a2 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                         (r1 - r2) / d
                end if
            end if
        end do
        vnew(i, :) = v(i, :)  + h / 2.d0 * (a1 + a2)

        ! periodic bd
        if (rnew(i, 1) &gt; L) then
            rnew(i, 1) = rnew(i, 1) - L
        elseif (rnew(i, 1) &lt; 0.d0) then
            rnew(i, 1) = rnew(i, 1) + L
        end if
        if (rnew(i, 2) &gt; L) then
            rnew(i, 2) = rnew(i, 2) - L
        elseif (rnew(i, 2) &lt; 0.d0) then
            rnew(i, 2) = rnew(i, 2) + L
        end if
    end do
    r = rnew
    v = vnew
end subroutine verlet

subroutine predcorr(NP, L, r, v, h, rbef, tol)
    implicit none
    integer :: NP, i, j, k
    double precision :: L, r(NP, 2), v(NP, 2), rnew(NP, 2), vnew(NP, 2)
    double precision :: a1(2), a2(2), d, dx, dy, r1(2), r2(2)
    double precision :: h
    double precision :: rbef(NP, 2), rp(2), rc(2), vc(2), diff, tol


    do i = 1, NP
        ! predictor
        rp = rbef(i, :) + 2.d0 * v(i, :) * h
        r1 = r(i, :)
        ! compute a(t)
        a1 = 0.d0
        do j = 1, NP
            if (i.ne.j) then
                r2 = r(j, :)
                d = dsqrt((r1(1) - r2(1))**2 + (r1(2) - r2(2))**2)
                if (d.gt.(L/2.d0)) then
                    ! find nearest image
                    dx = r2(1) - r1(1)
                    dy = r2(2) - r1(2)
                    if (dx.gt.(L/2.d0))  then; dx = dx - L; end if
                    if (dy.gt.(L/2.d0))  then; dy = dy - L; end if
                    if (dx.lt.(-L/2.d0)) then; dx = dx + L; end if
                    if (dy.lt.(-L/2.d0)) then; dy = dy + L; end if
                    d = dsqrt(dx ** 2 + dy ** 2)
                    a1 = a1 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                              (/ -dx, -dy /) / d
                else
                    a1 = a1 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                              (r1 - r2) / d
                end if
            end if
        end do
        ! calculate a^p
        k = 0
        do
            k = k + 1
            ! compute a(t+h)
            a2 = 0.d0
            r1 = rp
            do j = 1, NP
                if (i.ne.j) then
                    r2 = r(j, :)
                    d = dsqrt((r1(1) - r2(1))**2 + (r1(2) - r2(2))**2)
                    if (d.gt.(L/2.d0)) then
                        ! find nearest image
                        dx = r2(1) - r1(1)
                        dy = r2(2) - r1(2)
                        if (dx.gt.(L/2.d0))  then; dx = dx - L; end if
                        if (dy.gt.(L/2.d0))  then; dy = dy - L; end if
                        if (dx.lt.(-L/2.d0)) then; dx = dx + L; end if
                        if (dy.lt.(-L/2.d0)) then; dy = dy + L; end if
                        d = dsqrt(dx ** 2 + dy ** 2)
                        a2 = a2 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                             (/ -dx, -dy /) / d
                    else
                        a2 = a2 + (24.d0 / d) * (2.d0 * (1 / d)**12 - (1 / d)**6) * &amp;
                             (r1 - r2) / d
                    end if
                end if
            end do
            ! corrector
            vc = v(i, :) + .5d0 * h * (a1 + a2)
            rc = r(i, :) + .5d0 * h * (v(i, :) + vc)

            ! compute error
            diff = dsqrt( (rc(1) - rp(1))**2 + (rc(2) - rp(2))**2 )
            ! output diff
            ! open(66, file='data/diff.dat', access='append', status='unknown')
            ! write(66, '(2e40.30)') dble(k), diff
            ! close(66)
            ! print *, k, diff
            if ((diff.le.tol).or.(k.ge.8)) then
                exit
            else
                rp = rc
            end if
        end do
        rnew(i, :) = rc
        vnew(i, :) = vc

        ! periodic bd
        if (rnew(i, 1) &gt; L) then
            rnew(i, 1) = rnew(i, 1) - L
        elseif (rnew(i, 1) &lt; 0.d0) then
            rnew(i, 1) = rnew(i, 1) + L
        end if
        if (rnew(i, 2) &gt; L) then
            rnew(i, 2) = rnew(i, 2) - L
        elseif (rnew(i, 2) &lt; 0.d0) then
            rnew(i, 2) = rnew(i, 2) + L
        end if
    end do
    rbef = r
    r = rnew
    v = vnew
end subroutine predcorr

subroutine pstatus(n, i, time, T, P)
    implicit none
    integer :: n, i
    double precision :: time, T, P
    write(*, '(1a, 1f6.2, 1a5, 1a5, 1f4.1, 1a, 1a, 1a5, 1f6.2, 1a5, 1f8.2)') &amp;
    't:', time, '',  'left:', dble(n-i)/dble(n)*100.d0, '%', &amp;
    '', 'T=', T, 'P=', P
end subroutine pstatus
</code></pre> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <style>#clustrmaps-container{width:8vw;float:right;pointer-events:none}@media screen and (max-width:600px){#clustrmaps-container{width:35%;float:right}}</style> <footer class="sticky-bottom mt-5"> <div class="container"> <div id="clustrmaps-container"> <script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=XDvFmaRddfU91BwoWuLT6tdJsfWAV43WimAnxx0RGZ4"></script> </div> © Copyright 2024 Morris Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: December 21, 2024. <br><br> <a href="https://physics-morris.github.io/" target="_blank" rel="noopener noreferrer"> <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fmorris-huang.com&amp;count_bg=%23317773&amp;title_bg=%23F96167&amp;icon=react.svg&amp;icon_color=%23FFFFFF&amp;title=Views&amp;edge_flat=false"> </a> </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z9796LV2MV"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Z9796LV2MV");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>